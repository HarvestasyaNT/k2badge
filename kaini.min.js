let lang="en";var globalship=null,globalbg=null,globalavatar=null;let loader,tabManager;var k2={},colle={},shipDB={},fleets=[new Array(6),new Array(6),new Array(6),new Array(6)],fleetLevels=[[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1]],shipTypes={};function setCookie(e,t,a){var l=a?"; domain="+a:"";document.cookie=e+"="+encodeURIComponent(t)+"; max-age=31536000; path=/"+l}function getCookie(e){for(var t=e+"=",a=document.cookie.split(";"),l=0;l<a.length;l++){for(var i=a[l];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(t))return decodeURIComponent(i.substring(t.length,i.length))}return null}function store(e,t){storage?localStorage.setItem(e,t):setCookie(e,t)}function restore(e){var t=null;return storage&&(t=localStorage.getItem(e))?t:getCookie(e)}function getBase64Image(e){var t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0),t.toDataURL("image/png")}var storage=function(){var e,t,a=new Date;try{return(e=window.localStorage).setItem(a,a),t=e.getItem(a)==a,e.removeItem(a),t&&e}catch(e){}}();$(document).ready(function(){$(".shipClass").each(function(){for(var e=$(this).find("input").length,t=new Array(e);e--;)t[e]=!1;k2[this.id]=t});var e={},t=0,a=0,l={},i={},n=0,s={"016.png":{x:0,y:-140},"017.png":{x:0,y:-140},"021.png":{x:0,y:-140},"026.png":{x:0,y:-140},"037.png":{x:0,y:-140},"042a.png":{x:0,y:70},"042b.png":{x:0,y:70},"046.png":{x:0,y:-140},"057.png":{x:0,y:-140}},o=document.getElementById("result"),r=o.getContext("2d"),d=24,c=Math.sin(.523598776)*d,h=Math.cos(.523598776)*d,g=d+2*c,p=2*h,v=(5*g/4-p)/2,f=(5*g/4-g)/2+5,m="'Ubuntu', 'メイリオ', Times, serif",u="'Exo', 'メイリオ', Times, serif",b=function(e){d=e,c=Math.sin(.523598776)*d,h=Math.cos(.523598776)*d,v=(5*(g=d+2*c)/4-(p=2*h))/2,f=(5*g/4-g)/2+5},y=function(){($(this).hasClass("abyss")||(fleets[t][a]=$(this).prev("img").attr("id"),$("#fleets .chosen").html('<img style="height:50px; width:50px;" src="'+$(this).prev("img").attr("src")+'"/>')),0==t&&0==a)&&($(this).hasClass("damaged")||$(".damaged").removeClass("damaged"),$(this).toggleClass("damaged"),$(".flagship").removeClass("flagship"),$(this).prev("img").toggleClass("flagship"),n=shipDB[$(this).prev("img").attr("id").substring(4)]?shipDB[$(this).prev("img").attr("id").substring(4)].rarity:0,k("fleetFlagshipChange"))},k=function(e){if(console.log(e),$("#loadingDiv").html("Rendering..."),$("#buttons button").prop("disabled",!0),$("#save").prop("disabled",!0),r.clearRect(0,0,o.width,o.height),r.save(),r.fillStyle="#666",r.fillRect(0,0,o.width,o.height),$("#useBG").prop("checked"))D("displayBadge"!=$("#buttonToggles .active").attr("id")?132:parseInt(document.getElementById("roomY").value)),r.globalAlpha=.33,r.fillRect(0,0,o.width,o.height);else{var t=document.getElementById("bg"),a=$("#bgStretch").prop("checked"),l=$("#bgX").val()||0,i=$("#bgY").val()||0,n=$("#bgZ").val()||0;r.drawImage(t,l,i,a?o.width:t.width*(n/100),a?o.height:t.height*(n/100))}r.restore(),r.strokeRect(0,0,o.width,o.height),I()},x=function(e,t){var a=$("#avatar"),l=$(".flagship")[0]?$(".flagship")[0].id.substring(4):null,s=!1;l&&$("#hit"+l).hasClass("damaged")&&(s=!0);var d=$(".flagship").parent().length>0?$(".flagship").parent().attr("class"):null;if(null!=globalship)(c=new Image).onload=function(){var a=0,l=0;a+=document.getElementById("customX").value?parseInt(document.getElementById("customX").value):0,l+=document.getElementById("customY").value?parseInt(document.getElementById("customY").value):0,r.save();var i=document.getElementById("customZ").value?parseInt(document.getElementById("customZ").value)+100:100;i/=100,r.translate(o.width-7*c.width/8+a,o.height/2-c.height/5+l),r.translate(c.width/2,c.height/2),r.scale(i,i),r.drawImage(c,-c.width/2,-c.height/2),r.restore(),e(),t||w(r)},c.onerror=e,c.src=globalship;else if(l){var c;(c=new Image).onload=function(){var d=0,h=0;0==n&&i[l]?s&&i[l].offset2?(d=i[l].offset2.x,h=i[l].offset2.y):(d=i[l].offset.x,h=i[l].offset.y):shipDB[l]&&(s&&shipDB[l].offset2?(d=shipDB[l].offset2.x,h=shipDB[l].offset2.y):shipDB[l].offset&&(d=shipDB[l].offset.x,h=shipDB[l].offset.y)),d+=document.getElementById("customX").value?parseInt(document.getElementById("customX").value):0,h+=document.getElementById("customY").value?parseInt(document.getElementById("customY").value):0,r.save();var g=document.getElementById("customZ").value?parseInt(document.getElementById("customZ").value)+100:100;g>=50&&g<=150?(g/=100,r.translate(o.width-7*c.width/8+d,o.height/2-c.height/5+h),r.translate(c.width/2,c.height/2),r.scale(g,g),r.drawImage(c,-c.width/2,-c.height/2)):r.drawImage(c,o.width-7*c.width/8+d,o.height/2-c.height/5+h),r.restore(),e(),t||(a.attr("src")?w(r):C(r,l,n))},c.onerror=e,c.src="full/"+d+"/"+l+(s?"x":"")+".png"}else e(),a.attr("src")&&!t&&w(r)},C=function(e,t,a){a=document.getElementById("r"+a);var l=document.getElementById("icon"+t);e.save(),e.fillStyle="black",e.fillRect(35,.1875*o.height,100,100),e.strokeRect(35,.1875*o.height,100,100),e.restore(),e.drawImage(a,30,5,100,100,35,.1875*o.height,100,100),e.drawImage(l,35,.1875*o.height)},w=function(e){var t=document.getElementById("avatar");e.save(),e.fillStyle="transparent",e.fillRect(35,.1875*o.height,100,100),e.strokeRect(35,.1875*o.height,100,100),e.restore(),e.drawImage(t,35,.1875*o.height,100,100)},I=function(){var e=$("#buttonToggles .active").attr("id");"displayBadge"==e?$("#k2").prop("checked")?x(E):x(O):"displayPoster"==e?x(S,!0):"displayRoom"==e&&D(132)},S=function(){b(10),r.save();var e=$("[name='name']")[0],t=$("[name='level']")[0],a=$("[name='server'] :selected").text(),l=($("#useBlue").prop("checked"),10*(2*Math.sin(Math.PI/2)+1)),i=o.height-10,n=40+h,s=55+h;r.font="20px "+m,r.imageSmoothingEnabled=!0,r.fillStyle="white",r.strokeStyle="black",e.value?B(e.value,20,25,3):B("en"==lang?"Nameless Admiral":"無名提督",20,25,3),r.save(),r.font="10px "+m,r.globalCompositeOperation="lighter",r.fillStyle="rgba(255, 255, 255, 0.25)",r.strokeStyle="transparent";var d=new Date;B(d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate(),5,o.height-5,3),r.restore(),r.font="14px "+m,r.textAlign="right",B("en"==lang?"DE":"海",40,56);var c=0,g=$("#colleDiv .divDE img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divDE img").each(function(e){var t=55+c*p,a=Math.floor(c/40)*+l/2+55-15,i=document.getElementById(this.id);A(i,t,a,$(this).hasClass("selected"),!1),c++}),r.textAlign="left",r.font="14px "+u,B(g+"/"+c+" ("+(g/c*100).toFixed()+"%)",55+c*p+8,55),r.restore();var v=55+l/2+l/4;r.font="14px "+m,r.textAlign="right",B("en"==lang?"DD":"駆",n,v+10-9);var f=0,y=$("#colleDiv .divDD img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divDD img").each(function(e){var t=s+f%40*p;Math.floor(f/40%2)>0&&(t=s+(40-f%40)*p-h);var a=Math.floor(f/40)*+l/2+v-15,i=document.getElementById(this.id);A(i,t,a,$(this).hasClass("selected"),!1),f++}),r.textAlign="left",r.font="14px "+u,B(y+"/"+f+" ("+(y/f*100).toFixed()+"%)",s+40*p+8,v),r.restore();var k=v+l+l/4+8*Math.floor(f/40),x=k+l/2+l/4,C=x+l/2+l/4,w=C+l/2+l/4,I=w+l/2+l/4,S=I+l/2+l/4,D=S+l/2+l/4;B("en"==lang?"CL":"軽巡",40,k+10-9);var E=0,O=$("#colleDiv .divCL img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divCL img").each(function(){var e=55+E*p,t=k-15,a=document.getElementById(this.id);A(a,e,t,$(this).hasClass("selected"),!1),E++}),r.textAlign="left",r.font="14px "+u,B(O+"/"+E+" ("+(O/E*100).toFixed()+"%)",55+E*p+8,k),r.restore(),B("en"==lang?"CA":"重巡",n,x+10-9);var L=0,F=$("#colleDiv .divCA img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divCA img").each(function(){var e=s+L*p,t=x-15,a=document.getElementById(this.id);A(a,e,t,$(this).hasClass("selected"),!1),L++}),r.textAlign="left",r.font="14px "+u,B(F+"/"+L+" ("+(F/L*100).toFixed()+"%)",55+L*p+8,x),r.restore(),B("en"==lang?"CVL":"軽母",n,w+10-9);var R=0,T=$("#colleDiv .divCVL img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divCVL img").each(function(){var e=s+R*p,t=w-15,a=document.getElementById(this.id);A(a,e,t,$(this).hasClass("selected"),!1),R++}),r.textAlign="left",r.font="14px "+u,B(T+"/"+R+" ("+(T/R*100).toFixed()+"%)",s+R*p+8,w),r.restore(),B("en"==lang?"BB":"戦",40,C+10-9);var j=0,M=$("#colleDiv .divBB img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divBB img").each(function(){var e=55+j*p,t=C-15,a=document.getElementById(this.id);A(a,e,t,$(this).hasClass("selected"),!1),j++}),r.textAlign="left",r.font="14px "+u,B(M+"/"+j+" ("+(M/j*100).toFixed()+"%)",55+j*p+8,C),r.restore(),B("en"==lang?"CV":"航",40,I+10-9);var N=0,W=$("#colleDiv .divCV img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divCV img").each(function(){var e=55+N*p,t=I-15,a=document.getElementById(this.id);A(a,e,t,$(this).hasClass("selected"),!1),N++}),r.textAlign="left",r.font="14px "+u,B(W+"/"+N+" ("+(W/N*100).toFixed()+"%)",55+N*p+8,I),r.restore(),B("en"==lang?"SS":"潜",n,S+10-9);var Y=0,H=$("#colleDiv .divSS img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divSS img").each(function(){var e=s+Y*p,t=S-15,a=document.getElementById(this.id);A(a,e,t,$(this).hasClass("selected"),!1),Y++}),r.textAlign="left",r.font="14px "+u,B(H+"/"+Y+" ("+(H/Y*100).toFixed()+"%)",s+Y*p+8,S),r.restore(),B("en"==lang?"AX":"他",40,D+10-9);var P=0,U=$("#colleDiv .divAX img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divAX img").each(function(){var e=55+P*p,t=D-15,a=document.getElementById(this.id);A(a,e,t,$(this).hasClass("selected"),!1),P++}),r.textAlign="left",r.font="14px "+u,B(U+"/"+P+" ("+(U/P*100).toFixed()+"%)",55+P*p+8,D),r.restore(),r.font="12px "+m;var X=$("#colleDiv"),J=X.find("img.selected").length,Z=X.find("img").length,G=J+"/"+Z,V=J/Z;r.save(),r.strokeRect(540,i-10,300,8);var z=r.createLinearGradient(540,0,840,0);z.addColorStop(0,"#A00000"),z.addColorStop(.33,"#FF9900"),z.addColorStop(.66,"#DDDD33"),z.addColorStop(1,"#00A000"),r.fillStyle=z,r.fillRect(540,i-10,(300*V).toFixed(),8),r.restore(),r.font="20px "+u,B(G+" ("+(100*V).toFixed(1)+"%)",840,i-l/2,3),r.font="12px "+m,r.textAlign="right",B("Lv. "+(t.value?t.value:"?"),o.width/2,25),B("Your Server"!=a?a.substring(a.indexOf(" ")+1):"en"==lang?"Unknown Server":"不明サーバ",o.width-25,25),r.textAlign="left",r.restore(),$("#loadingDiv").html(""),$("#loadingProgress").hide(),$("#buttons button").prop("disabled",!1)},D=function(e){var t=(o.width,bg.clientWidth),a=document.getElementById("activeFloor"),l=document.getElementById("activeWall"),i=document.getElementById("activeDesk"),n=document.getElementById("activeOutside"),d=document.getElementById("activeWindow"),c=document.getElementById("activeObject"),h=document.getElementById("activeChest");r.globalAlpha=1,t=o.width/a.clientWidth,a.complete&&r.drawImage(a,0,150*t+e,o.width,a.clientHeight*t),l.complete&&r.drawImage(l,0,-125*t+e,o.width,l.clientHeight*t),c.complete&&r.drawImage(c,0,-125*t+e,c.clientWidth*t,c.clientHeight*t),n.complete&&r.drawImage(n,210,-125*t+e,n.clientWidth*t,n.clientHeight*t),d.complete&&r.drawImage(d,210,-125*t+e,d.clientWidth*t,d.clientHeight*t);var g=i.src.match(/(\d\d\d.?).png$/gm),p=null;g&&(p=s[g[0]]),p?r.drawImage(i,p.x,p.y+e+7,i.clientWidth*t,i.clientHeight*t):r.drawImage(i,0,e+7,i.clientWidth*t,i.clientHeight*t),r.drawImage(h,o.width-h.clientWidth*t,-125*t+e,h.clientWidth*t,h.clientHeight*t);var v=$("#tint-color").val();r.fillStyle=v||"#ffffff",$("#loadingDiv").html(""),$("#loadingProgress").hide(),$("#buttons button").prop("disabled",!1)},B=function(e,t,a,l){r.save(),r.lineWidth=void 0!==l?l:2,r.strokeText(e,t,a),r.fillText(e,t,a),r.restore()},A=function(e,t,a,l,i){r.save(),r.beginPath(),r.moveTo(t+h,a),r.lineTo(t+p,a+c),r.lineTo(t+p,a+c+d),r.lineTo(t+h,a+g),r.lineTo(t,a+d+c),r.lineTo(t,a+c),r.closePath(),r.stroke(),r.fillStyle=i||"white",r.globalAlpha=$("#hexOpa").val()?$("#hexOpa").val():0,r.fill(),r.globalAlpha=1,r.clip(),e&&l&&r.drawImage(e,t-v,a-f,5*g/4,5*g/4),r.restore()},E=function(){b(22),r.save(),r.strokeRect(35,45,100,100);var e=$("[name='name']")[0],t=$("[name='level']")[0],a=$("[name='server'] :selected").text(),l=45+1.5*d+8,i=l+1.5*d+8,n=i+1.5*d+8,s=210+h,c=225+h,g=s+h,v=c+h,f=g+h,u=v+h;r.font="20px "+m,r.imageSmoothingEnabled=!0,r.fillStyle="white",r.strokeStyle="black",e.value?B(e.value,20,25,3):B("en"==lang?"Nameless Admiral":"無名提督",20,25,3),r.save(),r.font="10px "+m,r.globalCompositeOperation="darker",r.fillStyle="rgba(255, 255, 255, 0.25)",r.strokeStyle="transparent";var y=new Date;B(y.getFullYear()+"-"+(y.getMonth()+1)+"-"+y.getDate(),5,o.height-5,3),r.restore(),r.font="14px "+m,r.textAlign="right",r.drawImage(document.getElementById("fleet1a"),187,45+d/2-15),r.drawImage(document.getElementById("fleet2a"),s-23,l+d/2-15),r.drawImage(document.getElementById("fleet3a"),g-23,i+d/2-15),r.drawImage(document.getElementById("fleet4a"),f-23,n+d/2-15),r.save(),r.fillStyle="white";for(var k=0;k<6;k++){var x=225+k*p,C=30,w=document.getElementById(fleets[0][k]),I=fleetLevels[0][k];A(w,x,C,!0),w&&(r.font="10px "+m,r.textAlign="left",B(I,x,C+8));x=c+k*p,C=l-15,w=document.getElementById(fleets[1][k]),I=fleetLevels[1][k];A(w,x,C,!0),w&&(r.font="10px "+m,r.textAlign="left",B(I,x,C+8));x=v+k*p,C=i-15,w=document.getElementById(fleets[2][k]),I=fleetLevels[2][k];A(w,x,C,!0),w&&(r.font="10px "+m,r.textAlign="left",B(I,x,C+8));x=u+k*p,C=n-15,w=document.getElementById(fleets[3][k]),I=fleetLevels[3][k];A(w,x,C,!0),w&&(r.font="10px "+m,r.textAlign="left",B(I,x,C+8))}r.restore(),r.font="12px "+m,r.textAlign="center",B("Lv. "+(t.value?t.value:"?"),85,n-1),B("Your Server"!=a?a.substring(a.indexOf(" ")+1):"en"==lang?"Unknown Server":"不明サーバ",85,n+14),r.textAlign="left",r.restore(),$("#loadingDiv").html(""),$("#buttons button").prop("disabled",!1)},O=function(){b(16),r.save(),r.strokeRect(35,.1875*o.height,100,100);var e=$("[name='name']")[0],t=$("[name='level']")[0],a=$("[name='server'] :selected").text(),l=$("#useBlue").prop("checked"),i=16*(2*Math.sin(Math.PI/2)+1),n=30,s=!0;r.font="20px "+m,r.imageSmoothingEnabled=!0,r.fillStyle="white",r.strokeStyle="black",e.value?B(e.value,20,25,3):B("en"==lang?"Nameless Admiral":"無名提督",20,25,3),r.save(),r.font="10px "+m,r.globalCompositeOperation="lighter",r.fillStyle="rgba(255, 255, 255, 0.25)",r.strokeStyle="transparent";var d=new Date;for(var c in B(d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate(),5,o.height-5,3),r.restore(),shipTypes)if(!(0==$("#"+c.toLowerCase()).find("[type='checkbox']").length||["SS","AX"].indexOf(c)>-1)){var g=shipTypes[c],v=175,f=v+15,y=(c.toLowerCase(),0),k=$("#"+c.toLowerCase()).find(".blueprint").not(".kai").length,x=$("#"+c.toLowerCase()).find("[type='checkbox']").length,C=$("#"+c.toLowerCase()).find("[type='checkbox']:checked").length;if(k>0&&l){x-=k;var w=$("#"+c.toLowerCase()).find(".blueprint").not(".kai").find("[type='checkbox']:checked").length;C=Math.max(0,C-w)}var I=Math.min(12,x);1==Math.floor((x-1)/12%2)&&(s=!s),x/12>1&&(n+=i*Math.floor(x/12)/2),s&&(v+=h,f+=h),r.font="14px "+m,r.textAlign="right",B("en"==lang?g[lang]:g.jp,v,n+16-9),r.save(),r.fillStyle="white",$($("#"+c.toLowerCase()).find("[type='checkbox']").get().reverse()).each(function(e){var t=$(this).parent().parent(),a=x-y-1;if(!l||!t.hasClass("blueprint")||t.hasClass("kai")){var s=f+a%12*p;Math.floor(a/12%2)>0&&(s=f+(12-(a+1)%12)*p-h);var o=Math.floor(a/12)*-i/2+n-15,r=document.getElementById("icon"+this.id),d=t.hasClass("blueprint")?t.hasClass("prototype")?"pink":"lightblue":"white";A(r,s,o,this.checked,d),y++}}),r.textAlign="left",r.font="14px "+u,B(C+"/"+y,f+I*p+8,n+16-9),r.restore(),n+=i/2,s=!s}var S=($("#cv").find("[type='checkbox']").length-(l?$("#cv").find(".blueprint").not(".kai").length:0)+3)*p,D=0,E=$("#ss").find("[type='checkbox']:checked").length;k=0;B("en"==lang?"SS":"潜",190+S,(n-=i)+i/2+16-9),r.save(),r.fillStyle="white",$("#ss").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(l&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&k++;else{var t=S+205+D*p,a=n-15+i/2,s=document.getElementById("icon"+this.id),o=$(this).parent().parent().find("label").hasClass("blueprint")?"lightblue":"white";A(s,t,a,this.checked,o),D++}}),r.textAlign="left",r.font="14px "+u,B(E-k+"/"+D,S+205+D*p+8,n+16-9+i/2),r.restore();var O=($("#cvl").find("[type='checkbox']").length-(l?$("#cvl").find(".blueprint").not(".kai").length:0)+3.5)*p,L=163+h,F=L+h;B("en"==lang?"AX":"その他",L+O,n+16-9);var R=0,T=$("#ax").find("[type='checkbox']:checked").length;k=0;r.save(),r.fillStyle="white",$("#ax").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(l&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&k++;else{var t=O+F+R*p,a=n-15,i=document.getElementById("icon"+this.id),s=$(this).parent().parent().find("label").hasClass("blueprint")?"lightblue":"white";A(i,t,a,this.checked,s),R++}}),r.textAlign="left",r.font="14px "+u,B(T-k+"/"+R,O+F+R*p+8,n+16-9),r.restore(),r.font="12px "+m;var j,M,N,W,Y,H,P=$(".shipOptions"),U=P.find(".blueprint").length-P.find(".kai").length,X=P.find(".blueprint :checked").length-P.find(".kai :checked").length,J=l?P.find("[type='checkbox']:checked").length-X:P.find("[type='checkbox']:checked").length,Z=l?P.find("[type='checkbox']").length-U:P.find("[type='checkbox']").length;N=20,W=(j=J)+"/"+(M=Z),Y=j/M,H=r.createLinearGradient(540,0,840,0),r.save(),r.strokeRect(540,o.height-N,300,8),H.addColorStop(0,"#A00000"),H.addColorStop(.33,"#FF9900"),H.addColorStop(.66,"#DDDD33"),H.addColorStop(1,"#00A000"),r.fillStyle=H,r.fillRect(540,o.height-N,(300*Y).toFixed(),8),r.restore(),r.font="20px "+u,B(W+" ("+(100*Y).toFixed(1)+"%)",840,o.height-20,3),r.font="12px "+m,r.textAlign="center",B("Lv. "+(t.value?t.value:"?"),85,173),"------"!==a?B("en"==lang?a.substring(a.indexOf(" ")+1):a,85,187):B("en"==lang?"Unknown Server":"不明サーバ",85,190),r.textAlign="left",r.restore(),$("#loadingDiv").html(""),$("#loadingProgress").hide(),$("#buttons button").prop("disabled",!1)},L=function(){for(var e in colle)$("#kore"+e).addClass("selected");for(var e in $(".flagship").removeClass("flagship"),$(".damaged").removeClass("damaged"),fleets[0]){var t=fleets[0][e],a=t.substring(4);if(null!==t&&""!==t){0==e&&($("#"+t).addClass("flagship"),n=shipDB[a]?shipDB[a].rarity:0);var l=parseInt(e)+1;$("#slot"+l).html('<img style="height:50px; width:50px;" src="icons/'+shipDB[a].type+"/"+a+'.png"/>')}}for(var e in fleetLevels[0]){var i=parseInt(fleetLevels[0][e]);if(i&&i>0){l=parseInt(e)+1;$("#level"+l).val(i)}}k("initial")};(loader=new DataLoader(lang)).initData(function(){var s=loader.getMstIdTable();if(shipTypes=loader.getShipTypes(),shipDB=loader.getShips(),i=loader.getAbyssals(),(tabManager=new TabManager(loader)).loadTabs(),apiMode){if(importName&&$("input[name='name']").val(importName),importLvl&&$("input[name='level']").val(importLvl),importServer&&$("select[name='server']").val(importServer),importShips){importShips=JSON.parse(importShips);var d={},c={};for(var h in importShips)if(importShips[h]in s&&(d[b=s[importShips[h]]]=!0,b in l.implicationTable))for(var g in l.implicationTable[b])d[l.implicationTable[b][g]]=!0;if(importK2){for(var h in d)if((b=$("#"+h)).length>0){var p=shipDB[h].type;c[p]||(c[p]={}),c[p][h]=!0,$("#"+h).prop("checked",!0)}k2=c}importColle&&(colle=d)}if(importFleets){importFleets=JSON.parse(importFleets);var v=[new Array(6),new Array(6),new Array(6),new Array(6)],f=[[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1]];for(var m in importFleets)for(var h in importFleets[m])importFleets[m][h]&&null!=importFleets[m][h]&&s[importFleets[m][h].id]&&(v[m][h]="icon"+s[importFleets[m][h].id],f[m][h]=importFleets[m][h].lvl);fleets=v,fleetLevels=f}}r.strokeRect(0,0,o.width,o.height),r.imageSmoothingEnabled=!0,r.mozImageSmoothingEnabled=!0,r.webkitImageSmoothingEnabled=!0;h=0;for(var u in shipDB){var b;if((b=shipDB[u]).name){var x=$('<img class="tooltip" title="'+b.full+'" src="icons/'+b.type+"/"+u+'.png" id="icon'+u+'"></img>'),C=$('<span id="hit'+u+'">破</span>');x.on("load",function(){h++,$("#loadingProgress").html(h+"/"+Object.keys(shipDB).length),h==Object.keys(shipDB).length&&L()}),0==$(".shipList [data-name='"+b.name+"']").length&&$(".div"+b.type).append("<div><label>"+b.name.replace(new RegExp("_","g")," ")+'</label><div data-name="'+b.name+'" class="'+b.type+'"></div></div>'),b.unique&&$("#colleDiv [data-name='"+b.name+"']").append('<img title="'+b.full+'"alt="full/FinalBoss.png" src="icons/'+b.type+"/"+u+'.png" id="kore'+u+'"></img>').append(C),$("#avatars [data-name='"+b.name+"']").append(x),0!=b.damageable&&$("#avatars [data-name='"+b.name+"']").append(C)}}$("#colleDiv .shipClasses").each(function(e){var t=$("<div class='colleAll'><input id='selectAll-"+e+"' type='checkbox'/><label for='selectAll-"+e+"'>"+("jp"==lang?"全て選択":"cn"==lang||"tw"==lang?"全選":"Select All")+"</label></div>");$(this).append(t),t.find("input").change(function(){var e=$(this).parent().parent().find("img");for(var t in e.toArray()){var a=$(e[t]);colle[a.attr("id").substring(4)]=this.checked,a.toggleClass("selected",this.checked)}k("colleChangeAll")})}),$(".tooltip").tooltipster(),$(".shipClasses").find("label").next("div").each(function(){0==$(this).find("img").length&&$(this).parent().remove()}),$("#fleetSelect div").click(function(){$("#fleetSelect .chosen").removeClass("chosen"),$(this).toggleClass("chosen");var e=this.id.substring(5);for(var a in t=parseInt(e)-1,$("#fleets div").html(""),$("#fleetLevels input").val(1),fleets[t]){var l=fleets[t][a],i=parseInt(a)+1;null!==l&&""!==l&&$("#slot"+i).html('<img style="height:50px; width:50px;" src="'+$("#"+l).attr("src")+'"/>'),$("#level"+i).val(fleetLevels[t][a])}}),$("#fleets div").click(function(){$("#fleets .chosen").removeClass("chosen"),$(this).toggleClass("chosen");var e=this.id.substring(4);a=parseInt(e)-1}),$("#fleetLevels input").change(function(){var e=this.id.substring(5);a=parseInt(e)-1,fleetLevels[t][a]=this.value,k("fleetLevelChange")}),$("#avatars img").on("click",function(){$(this).hasClass("abyss")||(fleets[t][a]=$(this).attr("id"),$("#fleets .chosen").html('<img style="height:50px; width:50px;" src="'+$(this).attr("src")+'"/>')),0==t&&0==a&&($(".flagship").removeClass("flagship"),$(".damaged").removeClass("damaged"),$(this).toggleClass("flagship"),n=shipDB[this.id.substring(4)]?shipDB[this.id.substring(4)].rarity:0),k("fleetShipChange")}),$("#colleDiv img").on("click",function(){colle[$(this).attr("id").substring(4)]&&$(this).hasClass("selected")?delete colle[$(this).attr("id").substring(4)]:$(this).hasClass("selected")||(colle[$(this).attr("id").substring(4)]=!0),$(this).toggleClass("selected"),k("colleChange")}),$("#avatars span").on("click",y),$(".shipList > label").click(function(){$(this).next("div").slideToggle()}),$(".shipClasses label").click(function(){$(this).next("div").toggle()}),$("#removeSlot").click(function(){0==t&&0==a&&($(".damaged").removeClass("damaged"),$(".flagship").removeClass("flagship"),n=0),fleets[t][a]=null,$("#fleets .chosen").html(""),k("fleetRemoveSlot")}),$(".shipOptions input[type='checkbox']").change(function(){k("kainiShipChange")}),$("#selectAll").on("change",function(){this.checked?$(".shipOptions [type='checkbox']").prop("checked",!0):$(".shipOptions [type='checkbox']").prop("checked",!1),k("kainiSelectAll")}),$("#displayBadge").on("click",function(){$("#buttonToggles button").removeClass("active"),$(this).addClass("active"),o.width=850,o.height=320,k("displayBadge")}),$("#displayRoom").on("click",function(){$("#buttonToggles button").removeClass("active"),$(this).addClass("active"),o.width=850,o.height=510,D(132)}),$("#displayPoster").on("click",function(){$("#buttonToggles button").removeClass("active"),$(this).addClass("active"),o.width=850,o.height=510,k("displayPoster")}),$("#generate").on("click",k),$("#Floor,#Wall,#Desk,#Object,#Chest,#Window").on("change",function(){var t=this.id;delete e[t];var a=$("#active"+t),l=$(this).find(":checked").val();a.off("load"),a.attr("src","furniture/"+this.id.toLowerCase()+"/"+l+".png"),a.prop("complete")?$.isEmptyObject(e)&&"Window"!=t&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?D(132):k("furnitureChangeCache")):(e[t]=l,$("#buttons button").prop("disabled",!0),$("#loadingDiv").html("Rendering..."),a.load(function(){delete e[t],$.isEmptyObject(e)&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?D(132):k("furnitureChangeLoaded"))}).error(function(){delete e[t],$.isEmptyObject(e)&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html("Couldn't find this furniture's image."))})),"Window"==t&&$("#Outside").change()}),$("#Outside").on("change",function(t){delete e.Outside;var a=$("#activeOutside"),l=$("#Outside").find(":checked"),i=$("#Window").find(":checked").attr("data-pType"),n="furniture/outside/"+(l.val()+i)+".png";a.off("load"),a.attr("src",n),a.prop("complete")&&$.isEmptyObject(e)?($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?D(132):k("furnitureOutsideCache")):a.load(function(){delete e.Outside,$.isEmptyObject(e)&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?D(132):k("furnitureOutsideLoaded"))})}),$("#ttkInfo input[type='text'],#ttkInfo input[type='number']").blur(function(){k("ttkInfo")}),$("#ttkInfo select").click(function(){k("ttkServer")}),$("#ttkInfo input[type='checkbox']").click(function(){k("ttkLevel")}),$("#loadAbyss").click(function(){$("#loadAbyss").remove(),$("#avatars .hidden").removeClass("hidden"),$.ajax({dataType:"json",timeout:1e4,url:"en"==lang?"db2.json?v=13":"db2j.json?v=13",success:function(e){i=e,$("#loadingDiv").html("Loading images: "),$("#loadingProgress").show().html("0/"+Object.keys(e).length);var t=0;for(var a in i){var l=e[a];if(l.name){var s=$('<img class="abyss tooltip2" title="'+l.full+'" src="icons/'+l.type+"/"+a+'.png" id="icon'+a+'"></img>'),o=$('<span class="abyss" id="hit'+a+'">破</span>');s.on("load",function(){t++,$("#loadingProgress").html(t+"/"+Object.keys(e).length),t==Object.keys(e).length&&($("#loadingDiv").html(""),$("#loadingProgress").hide())}),s.on("click",function(){$(".flagship").removeClass("flagship"),$(".damaged").removeClass("damaged"),$(this).toggleClass("flagship"),n=0,k("fleetShipChangeAbyss")}),0==$(".shipList [data-name='"+l.name+"']").length&&$(".div"+l.type).append("<div><label>"+l.name.replace(new RegExp("_","g")," ")+'</label><div data-name="'+l.name+'" class="'+l.type+'"></div></div>'),$("#avatars [data-name='"+l.name+"']").append(s),l.damageable&&$("#avatars [data-name='"+l.name+"']").append(o)}}$("#avatars span").unbind("click").on("click",y),$(".tooltip2").tooltipster()},error:function(){$("#loadingDiv").html("Can't find Abyssal DB, please contact Harvestasya or Nya-chan on Github")}})}),$("#save").on("click",function(){!function(){var e=$(".furnitureClass input:checked").toArray(),t={};for(var a in e)t[e[a].name]=e[a].id;$(".shipClass").each(function(){var e=this.id,t=$(this).find("input"),a={};t.each(function(e){a[this.id]=$(this).prop("checked")}),k2[e]=a}),store("ttkName",$("input[name='name']").val()),store("ttkLvl",$("input[name='level']").val()),store("ttkServer",$("select[name='server']").val()),store("ttkFurn",Base64.encode(JSON.stringify(t))),store("ttkFurnCam",$("#roomY").val()),store("ttkTint",$("#tint-color").val()),store("ttkHexOpa",$("#hexOpa").val()),store("k2",Base64.encode(JSON.stringify(k2))),store("secretaryCam",JSON.stringify([$("#customX").val(),$("#customY").val(),$("#customZ").val()])),store("secretaryHit",$(".damaged").size()>0&&!$($(".damaged")[0]).hasClass("abyss")),store("fleet",Base64.encode(fleets.join("|"))),store("fleetLvl",Base64.encode(fleetLevels.join("|"))),store("colle",Base64.encode(JSON.stringify(colle))),store("bg",globalbg),store("bgUse",$("#useBG").prop("checked")),store("bgCam",JSON.stringify([$("#bgX").val(),$("#bgY").val(),$("#bgZ").val()])),store("bgStretch",$("#bgStretch").prop("checked")),store("avatar",globalavatar)}(),this.setAttribute("disabled","disabled")}),$("#load").on("click",function(){!function(){$(".flagship").removeClass("flagship"),$(".damaged").removeClass("damaged"),$("input[name='name']").val(restore("ttkName")),$("input[name='level']").val(restore("ttkLvl"));var e=restore("bgCam");e=e?JSON.parse(e):[0,0,100],$("#bgX").val(e[0]),$("#bgY").val(e[1]),$("#bgZ").val(e[2]),$("#useBG").prop("checked",!restore("bgUse")||"true"==restore("bgUse"));var t=restore("secretaryCam");t=t?JSON.parse(t):[0,0,0],$("#customX").val(t[0]),$("#customY").val(t[1]),$("#customZ").val(t[2]),$("#roomY").val(restore("ttkFurnCam")||0),$("#tint-color").val(restore("ttkTint")||"#ffffff"),$("#hexOpa").val(restore("ttkHexOpa")||.33),$("#hexOpa").val(restore("ttkHexOpa")||.33),$("#bgStretch").prop("checked",!restore("bgStretch")||"true"==restore("bgStretch")),"null"!=(globalbg=restore("bg"))&&$("#bg").attr("src",globalbg),"null"!=(globalavatar=restore("avatar"))?$("#avatar").attr("src",globalavatar):$("#avatar").removeAttr("src");var a=restore("ttkServer");"null"!=a&&$("select[name='server']").val(a);var l=restore("k2");l=l?JSON.parse(Base64.decode(l)):null;var i=restore("colle");i=i?JSON.parse(Base64.decode(i)):null;var s=restore("ttkFurn");s=s?JSON.parse(Base64.decode(s)):null;var o=restore("fleet");for(var r in o=o?Base64.decode(o).split("|"):null)o[r]=o[r].split(",");var d=restore("fleetLvl");for(var r in d=d?Base64.decode(d).split("|"):null)d[r]=d[r].split(",");if(l)for(var r in k2=l,$(".shipClass input").prop("checked",!1),k2)for(var c in k2[r])$("#"+c).prop("checked",k2[r][c]);if(i)for(var r in colle=i,$("#colleDiv img").removeClass("selected"),colle)$("#kore"+r).addClass("selected");if(o)for(var r in(fleets=o)[0]){var h=fleets[0][r];if(null!==h&&""!==h){0==r&&($("#"+h).addClass("flagship"),"true"==restore("secretaryHit")&&$("#"+h).next("span").addClass("damaged"),n=shipDB[h.substring(4)]?shipDB[h.substring(4)].rarity:0);var g=parseInt(r)+1;$("#slot"+g).html('<img style="height:50px; width:50px;" src="'+$("#"+h).attr("src")+'"/>')}}if(d)for(var r in(fleetLevels=d)[0]){var p=parseInt(fleetLevels[0][r]);p&&p>0&&(g=parseInt(r)+1,$("#level"+g).val(p))}if(s){var v=0;$("#buttons button").prop("disabled",!0),$("#loadingDiv").html("Rendering...");var f=!1;for(var r in s){var m=s[r],u=$("#"+m);u.prop("checked",!0);var b=u.parent().parent().parent().attr("id"),y=$("#active"+b);if(y.off("load"),"Outside"==b){var x=$("#Outside").find(":checked"),C=$("#Window").find(":checked").attr("data-pType"),w="furniture/outside/"+(I=x.val()+C)+".png";y.attr("src",w)}else{var I=u.val();y.attr("src","furniture/"+b.toLowerCase()+"/"+I+".png")}y.prop("complete")?++v==Object.keys(s).length&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?D(132):k("loadAllImgCached")):y.load(function(){++v==Object.keys(s).length&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(f?"Couldn't find a furniture's image.":""),$("#displayRoom").hasClass("on")?D(132):k("loadAllImgLoaded"))}).error(function(e){f=!0,++v==Object.keys(s).length&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html("Couldn't find a furniture's image."))})}}else k("loadNoFurniture")}()}),$("#export").on("click",function(){var e=document.createElement("img");$(e).attr("src",o.toDataURL("image/png"));var t=document.createElement("div");$(t).attr("class","export-container"),$(t).append(e);var a=document.createElement("span");$(a).text('Right-click the image and choose "Save As..." to save it to your computer.'),$(t).append(a);var l=document.createElement("span");$(l).attr("class","close"),$(l).text("+"),$(t).append(l),$("body").prepend(t)}),$("body").on("click",".export-container",function(){$(".export-container").remove()}),$("#avatar").load(function(){$.isEmptyObject(e)&&k("avatarImgChange")}),$("#bg").load(function(){$.isEmptyObject(e)&&k("bgImgChange")}),$("#customInputs input[type='checkbox']").change(function(){k("customInputChange")}),$("#customInputs input[type='number']").change(function(){k("customInputChange")}),$("#avatarImg").change(function(){if(this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){$("#avatar").attr("src",e.target.result),globalavatar=e.target.result},e.readAsDataURL(this.files[0])}}),$("#shipImg").change(function(){if(this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){$("#customShip").attr("src",e.target.result),globalship=e.target.result,k("customShipChange")},e.readAsDataURL(this.files[0])}}),$("#bgImg").change(function(){if($("#useBG").prop("checked",!1),this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){$("#bg").attr("src",e.target.result),globalbg=e.target.result},e.readAsDataURL(this.files[0])}}),$("#shipClear").click(function(){globalship=null,$("#shipImg").val(""),$("#customShip").removeAttr("src"),k("clear")}),$("#avatarClear").click(function(){globalavatar=null,$("#avatarImg").val(""),$("#avatar").removeAttr("src"),k("clear")}),$("#bgClear").click(function(){globalbg=null,$("#bgImg").val(""),$("#bg").attr("src","bg.jpg"),k("clear")})})}),$(window).load(function(){$("#tabs").liteTabs({width:"100%"}),$("#tabs").show(),$(".furnitureClass.invert > div div").each(function(){$(this).prependTo(this.parentNode)})});