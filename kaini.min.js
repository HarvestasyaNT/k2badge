var lang="en",globalship=null,globalbg=null,globalavatar=null,k2={},colle={},shipDB={},fleets=[new Array(6),new Array(6),new Array(6),new Array(6)],fleetLevels=[[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1]],shipTypes={};function setCookie(e,t,a){var l=a?"; domain="+a:"";document.cookie=e+"="+encodeURIComponent(t)+"; max-age=31536000; path=/"+l}function getCookie(e){for(var t=e+"=",a=document.cookie.split(";"),l=0;l<a.length;l++){for(var i=a[l];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(t))return decodeURIComponent(i.substring(t.length,i.length))}return null}function store(e,t){storage?localStorage.setItem(e,t):setCookie(e,t)}function restore(e){var t=null;return storage&&(t=localStorage.getItem(e))?t:getCookie(e)}function getBase64Image(e){var t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0),t.toDataURL("image/png")}var storage=function(){var e,t,a=new Date;try{return(e=window.localStorage).setItem(a,a),t=e.getItem(a)==a,e.removeItem(a),t&&e}catch(e){}}();$(document).ready(function(){$(".shipClass").each(function(){for(var e=$(this).find("input").length,t=new Array(e);e--;)t[e]=!1;k2[this.id]=t});var e={},t=0,a=0,l={},i={},n=0;$.ajax({dataType:"json",timeout:1e4,url:"en"==lang?"db.json?v=13":"dbj.json?v=13"}).then(function(e){shipDB=e,$.ajax({dataType:"json",timeout:1e4,url:"conversion.json?v=13"}).then(function(e){l=e,R()},function(e){console.log("import db not found or invalid format, not performing import"),R()})},function(){$("#buttons").html("Can't find Kanmusu DB, please contact Harvestasya or Nya-chan on Github"),$("#tabs").remove()});var s={"016.png":{x:0,y:-140},"017.png":{x:0,y:-140},"021.png":{x:0,y:-140},"026.png":{x:0,y:-140},"037.png":{x:0,y:-140},"042a.png":{x:0,y:70},"042b.png":{x:0,y:70},"046.png":{x:0,y:-140},"057.png":{x:0,y:-140}},o=document.getElementById("result"),r=o.getContext("2d"),d=.523598776,c=24,h=Math.sin(d)*c,g=Math.cos(d)*c,p=c+2*h,v=2*g,f=(5*p/4-v)/2,m=(5*p/4-p)/2+5,u="'Ubuntu', 'メイリオ', Times, serif",b="'Exo', 'メイリオ', Times, serif",y=function(e){c=e,h=Math.sin(d)*c,g=Math.cos(d)*c,f=(5*(p=c+2*h)/4-(v=2*g))/2,m=(5*p/4-p)/2+5},k=function(){($(this).hasClass("abyss")||(fleets[t][a]=$(this).prev("img").attr("id"),$("#fleets .chosen").html('<img style="height:50px; width:50px;" src="'+$(this).prev("img").attr("src")+'"/>')),0==t&&0==a)&&($(this).hasClass("damaged")||$(".damaged").removeClass("damaged"),$(this).toggleClass("damaged"),$(".flagship").removeClass("flagship"),$(this).prev("img").toggleClass("flagship"),n=shipDB[$(this).prev("img").attr("id").substring(4)]?shipDB[$(this).prev("img").attr("id").substring(4)].rarity:0,x("fleetFlagshipChange"))},x=function(e){if(console.log(e),$("#loadingDiv").html("Rendering..."),$("#buttons button").prop("disabled",!0),$("#save").prop("disabled",!0),r.clearRect(0,0,o.width,o.height),r.save(),r.fillStyle="#666",r.fillRect(0,0,o.width,o.height),$("#useBG").prop("checked"))D("displayBadge"!=$("#buttonToggles .active").attr("id")?132:parseInt(document.getElementById("roomY").value)),r.globalAlpha=.33,r.fillRect(0,0,o.width,o.height);else{var t=document.getElementById("bg"),a=$("#bgStretch").prop("checked"),l=$("#bgX").val()||0,i=$("#bgY").val()||0,n=$("#bgZ").val()||0;r.drawImage(t,l,i,a?o.width:t.width*(n/100),a?o.height:t.height*(n/100))}r.restore(),r.strokeRect(0,0,o.width,o.height),S()},C=function(e,t){var a=$("#avatar"),l=$(".flagship")[0]?$(".flagship")[0].id.substring(4):null,s=!1;l&&$("#hit"+l).hasClass("damaged")&&(s=!0);var d=$(".flagship").parent().length>0?$(".flagship").parent().attr("class"):null;if(null!=globalship)(c=new Image).onload=function(){var a=0,l=0;a+=document.getElementById("customX").value?parseInt(document.getElementById("customX").value):0,l+=document.getElementById("customY").value?parseInt(document.getElementById("customY").value):0,r.save();var i=document.getElementById("customZ").value?parseInt(document.getElementById("customZ").value)+100:100;i/=100,r.translate(o.width-7*c.width/8+a,o.height/2-c.height/5+l),r.translate(c.width/2,c.height/2),r.scale(i,i),r.drawImage(c,-c.width/2,-c.height/2),r.restore(),e(),t||I(r)},c.onerror=e,c.src=globalship;else if(l){var c;(c=new Image).onload=function(){var d=0,h=0;0==n&&i[l]?s&&i[l].offset2?(d=i[l].offset2.x,h=i[l].offset2.y):(d=i[l].offset.x,h=i[l].offset.y):shipDB[l]&&(s&&shipDB[l].offset2?(d=shipDB[l].offset2.x,h=shipDB[l].offset2.y):shipDB[l].offset&&(d=shipDB[l].offset.x,h=shipDB[l].offset.y)),d+=document.getElementById("customX").value?parseInt(document.getElementById("customX").value):0,h+=document.getElementById("customY").value?parseInt(document.getElementById("customY").value):0,r.save();var g=document.getElementById("customZ").value?parseInt(document.getElementById("customZ").value)+100:100;g>=50&&g<=150?(g/=100,r.translate(o.width-7*c.width/8+d,o.height/2-c.height/5+h),r.translate(c.width/2,c.height/2),r.scale(g,g),r.drawImage(c,-c.width/2,-c.height/2)):r.drawImage(c,o.width-7*c.width/8+d,o.height/2-c.height/5+h),r.restore(),e(),t||(a.attr("src")?I(r):w(r,l,n))},c.onerror=e,c.src="full/"+d+"/"+l+(s?"x":"")+".png"}else e(),a.attr("src")&&!t&&I(r)},w=function(e,t,a){a=document.getElementById("r"+a);var l=document.getElementById("icon"+t);e.save(),e.fillStyle="black",e.fillRect(35,45,100,100),e.strokeRect(35,45,100,100),e.restore(),e.drawImage(a,30,5,100,100,35,45,100,100),e.drawImage(l,35,45)},I=function(e){var t=document.getElementById("avatar");e.save(),e.fillStyle="transparent",e.fillRect(35,45,100,100),e.strokeRect(35,45,100,100),e.restore(),e.drawImage(t,35,45,100,100)},S=function(){var e=$("#buttonToggles .active").attr("id");"displayBadge"==e?$("#k2").prop("checked")?C(O):C(L):"displayPoster"==e?C(B,!0):"displayRoom"==e&&D(132)},B=function(){y(10),r.save();var e=$("[name='name']")[0],t=$("[name='level']")[0],a=$("[name='server'] :selected").text(),l=($("#useBlue").prop("checked"),10*(2*Math.sin(Math.PI/2)+1)),i=o.height-10,n=40+g,s=55+g;r.font="20px "+u,r.imageSmoothingEnabled=!0,r.fillStyle="white",r.strokeStyle="black",e.value?A(e.value,20,25,3):A("en"==lang?"Nameless Admiral":"無名提督",20,25,3),r.save(),r.font="10px "+u,r.globalCompositeOperation="lighter",r.fillStyle="rgba(255, 255, 255, 0.25)",r.strokeStyle="transparent";var d=new Date;A(d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate(),5,o.height-5,3),r.restore(),r.font="14px "+u,r.textAlign="right",A("en"==lang?"DE":"海",40,56);var c=0,h=$("#colleDiv .divDE img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divDE img").each(function(e){var t=55+c*v,a=Math.floor(c/40)*+l/2+55-15,i=document.getElementById(this.id);E(i,t,a,$(this).hasClass("selected"),!1),c++}),r.textAlign="left",r.font="14px "+b,A(h+"/"+c+" ("+(h/c*100).toFixed()+"%)",55+c*v+8,55),r.restore();var p=55+l/2+l/4;r.font="14px "+u,r.textAlign="right",A("en"==lang?"DD":"駆",n,p+10-9);var f=0,m=$("#colleDiv .divDD img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divDD img").each(function(e){var t=s+f%40*v;Math.floor(f/40%2)>0&&(t=s+(40-f%40)*v-g);var a=Math.floor(f/40)*+l/2+p-15,i=document.getElementById(this.id);E(i,t,a,$(this).hasClass("selected"),!1),f++}),r.textAlign="left",r.font="14px "+b,A(m+"/"+f+" ("+(m/f*100).toFixed()+"%)",s+40*v+8,p),r.restore();var k=p+l+l/4+8*Math.floor(f/40),x=k+l/2+l/4,C=x+l/2+l/4,w=C+l/2+l/4,I=w+l/2+l/4,S=I+l/2+l/4,B=S+l/2+l/4;A("en"==lang?"CL":"軽巡",40,k+10-9);var D=0,O=$("#colleDiv .divCL img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divCL img").each(function(){var e=55+D*v,t=k-15,a=document.getElementById(this.id);E(a,e,t,$(this).hasClass("selected"),!1),D++}),r.textAlign="left",r.font="14px "+b,A(O+"/"+D+" ("+(O/D*100).toFixed()+"%)",55+D*v+8,k),r.restore(),A("en"==lang?"CA":"重巡",n,x+10-9);var L=0,F=$("#colleDiv .divCA img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divCA img").each(function(){var e=s+L*v,t=x-15,a=document.getElementById(this.id);E(a,e,t,$(this).hasClass("selected"),!1),L++}),r.textAlign="left",r.font="14px "+b,A(F+"/"+L+" ("+(F/L*100).toFixed()+"%)",55+L*v+8,x),r.restore(),A("en"==lang?"CVL":"軽母",n,w+10-9);var R=0,j=$("#colleDiv .divCVL img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divCVL img").each(function(){var e=s+R*v,t=w-15,a=document.getElementById(this.id);E(a,e,t,$(this).hasClass("selected"),!1),R++}),r.textAlign="left",r.font="14px "+b,A(j+"/"+R+" ("+(j/R*100).toFixed()+"%)",s+R*v+8,w),r.restore(),A("en"==lang?"BB":"戦",40,C+10-9);var T=0,N=$("#colleDiv .divBB img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divBB img").each(function(){var e=55+T*v,t=C-15,a=document.getElementById(this.id);E(a,e,t,$(this).hasClass("selected"),!1),T++}),r.textAlign="left",r.font="14px "+b,A(N+"/"+T+" ("+(N/T*100).toFixed()+"%)",55+T*v+8,C),r.restore(),A("en"==lang?"CV":"航",40,I+10-9);var M=0,W=$("#colleDiv .divCV img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divCV img").each(function(){var e=55+M*v,t=I-15,a=document.getElementById(this.id);E(a,e,t,$(this).hasClass("selected"),!1),M++}),r.textAlign="left",r.font="14px "+b,A(W+"/"+M+" ("+(W/M*100).toFixed()+"%)",55+M*v+8,I),r.restore(),A("en"==lang?"SS":"潜",n,S+10-9);var Y=0,H=$("#colleDiv .divSS img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divSS img").each(function(){var e=s+Y*v,t=S-15,a=document.getElementById(this.id);E(a,e,t,$(this).hasClass("selected"),!1),Y++}),r.textAlign="left",r.font="14px "+b,A(H+"/"+Y+" ("+(H/Y*100).toFixed()+"%)",s+Y*v+8,S),r.restore(),A("en"==lang?"AX":"他",40,B+10-9);var P=0,U=$("#colleDiv .divAX img.selected").length;r.save(),r.fillStyle="white",$("#colleDiv .divAX img").each(function(){var e=55+P*v,t=B-15,a=document.getElementById(this.id);E(a,e,t,$(this).hasClass("selected"),!1),P++}),r.textAlign="left",r.font="14px "+b,A(U+"/"+P+" ("+(U/P*100).toFixed()+"%)",55+P*v+8,B),r.restore(),r.font="12px "+u;var X=$("#colleDiv"),J=X.find("img.selected").length,Z=X.find("img").length,G=J+"/"+Z,V=J/Z;r.save(),r.strokeRect(540,i-10,300,8);var z=r.createLinearGradient(540,0,840,0);z.addColorStop(0,"#A00000"),z.addColorStop(.33,"#FF9900"),z.addColorStop(.66,"#DDDD33"),z.addColorStop(1,"#00A000"),r.fillStyle=z,r.fillRect(540,i-10,(300*V).toFixed(),8),r.restore(),r.font="20px "+b,A(G+" ("+(100*V).toFixed()+"%)",840,i-l/2,3),r.font="12px "+u,r.textAlign="right",A("Lv. "+(t.value?t.value:"?"),o.width/2,25),A("Your Server"!=a?a.substring(a.indexOf(" ")+1):"en"==lang?"Unknown Server":"不明サーバ",o.width-25,25),r.textAlign="left",r.restore(),$("#loadingDiv").html(""),$("#loadingProgress").hide(),$("#buttons button").prop("disabled",!1)},D=function(e){var t=(o.width,bg.clientWidth),a=document.getElementById("activeFloor"),l=document.getElementById("activeWall"),i=document.getElementById("activeDesk"),n=document.getElementById("activeOutside"),d=document.getElementById("activeWindow"),c=document.getElementById("activeObject"),h=document.getElementById("activeChest");r.globalAlpha=1,t=o.width/a.clientWidth,a.complete&&r.drawImage(a,0,150*t+e,o.width,a.clientHeight*t),l.complete&&r.drawImage(l,0,-125*t+e,o.width,l.clientHeight*t),c.complete&&r.drawImage(c,0,-125*t+e,c.clientWidth*t,c.clientHeight*t),n.complete&&r.drawImage(n,210,-125*t+e,n.clientWidth*t,n.clientHeight*t),d.complete&&r.drawImage(d,210,-125*t+e,d.clientWidth*t,d.clientHeight*t);var g=i.src.match(/(\d\d\d.?).png$/gm),p=null;g&&(p=s[g[0]]),p?r.drawImage(i,p.x,p.y+e+7,i.clientWidth*t,i.clientHeight*t):r.drawImage(i,0,e+7,i.clientWidth*t,i.clientHeight*t),r.drawImage(h,o.width-h.clientWidth*t,-125*t+e,h.clientWidth*t,h.clientHeight*t);var v=$("#tint-color").val();r.fillStyle=v||"#ffffff",$("#loadingDiv").html(""),$("#loadingProgress").hide(),$("#buttons button").prop("disabled",!1)},A=function(e,t,a,l){r.save(),r.lineWidth=void 0!==l?l:2,r.strokeText(e,t,a),r.fillText(e,t,a),r.restore()},E=function(e,t,a,l,i){r.save(),r.beginPath(),r.moveTo(t+g,a),r.lineTo(t+v,a+h),r.lineTo(t+v,a+h+c),r.lineTo(t+g,a+p),r.lineTo(t,a+c+h),r.lineTo(t,a+h),r.closePath(),r.stroke(),r.fillStyle=i||"white",r.globalAlpha=$("#hexOpa").val()?$("#hexOpa").val():0,r.fill(),r.globalAlpha=1,r.clip(),e&&l&&r.drawImage(e,t-f,a-m,5*p/4,5*p/4),r.restore()},O=function(){y(22),r.save(),r.strokeRect(35,45,100,100);var e=$("[name='name']")[0],t=$("[name='level']")[0],a=$("[name='server'] :selected").text(),l=45+1.5*c+8,i=l+1.5*c+8,n=i+1.5*c+8,s=210+g,d=225+g,h=s+g,p=d+g,f=h+g,m=p+g;r.font="20px "+u,r.imageSmoothingEnabled=!0,r.fillStyle="white",r.strokeStyle="black",e.value?A(e.value,20,25,3):A("en"==lang?"Nameless Admiral":"無名提督",20,25,3),r.save(),r.font="10px "+u,r.globalCompositeOperation="darker",r.fillStyle="rgba(255, 255, 255, 0.25)",r.strokeStyle="transparent";var b=new Date;A(b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate(),5,o.height-5,3),r.restore(),r.font="14px "+u,r.textAlign="right",r.drawImage(document.getElementById("fleet1a"),187,45+c/2-15),r.drawImage(document.getElementById("fleet2a"),s-23,l+c/2-15),r.drawImage(document.getElementById("fleet3a"),h-23,i+c/2-15),r.drawImage(document.getElementById("fleet4a"),f-23,n+c/2-15),r.save(),r.fillStyle="white";for(var k=0;k<6;k++){var x=225+k*v,C=30,w=document.getElementById(fleets[0][k]),I=fleetLevels[0][k];E(w,x,C,!0),w&&(r.font="10px "+u,r.textAlign="left",A(I,x,C+8));x=d+k*v,C=l-15,w=document.getElementById(fleets[1][k]),I=fleetLevels[1][k];E(w,x,C,!0),w&&(r.font="10px "+u,r.textAlign="left",A(I,x,C+8));x=p+k*v,C=i-15,w=document.getElementById(fleets[2][k]),I=fleetLevels[2][k];E(w,x,C,!0),w&&(r.font="10px "+u,r.textAlign="left",A(I,x,C+8));x=m+k*v,C=n-15,w=document.getElementById(fleets[3][k]),I=fleetLevels[3][k];E(w,x,C,!0),w&&(r.font="10px "+u,r.textAlign="left",A(I,x,C+8))}r.restore(),r.font="12px "+u,r.textAlign="center",A("Lv. "+(t.value?t.value:"?"),85,n-1),A("Your Server"!=a?a.substring(a.indexOf(" ")+1):"en"==lang?"Unknown Server":"不明サーバ",85,n+14),r.textAlign="left",r.restore(),$("#loadingDiv").html(""),$("#buttons button").prop("disabled",!1)},L=function(){y(16),r.save(),r.strokeRect(35,45,100,100);var e=$("[name='name']")[0],t=$("[name='level']")[0],a=$("[name='server'] :selected").text(),l=$("#useBlue").prop("checked"),i=16*(2*Math.sin(Math.PI/2)+1),n=10,s=!0;r.font="20px "+u,r.imageSmoothingEnabled=!0,r.fillStyle="white",r.strokeStyle="black",e.value?A(e.value,20,25,3):A("en"==lang?"Nameless Admiral":"無名提督",20,25,3),r.save(),r.font="10px "+u,r.globalCompositeOperation="lighter",r.fillStyle="rgba(255, 255, 255, 0.25)",r.strokeStyle="transparent";var d=new Date;A(d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate(),5,o.height-5,3),r.restore();for(var c in shipTypes)if(!(0==$("#"+c.toLowerCase()).find("[type='checkbox']").length||["SS","AX"].indexOf(c)>-1)){var h=shipTypes[c],p=175,f=p+15,m=(c.toLowerCase(),0),k=$("#"+c.toLowerCase()).find(".blueprint").not(".kai").length,x=$("#"+c.toLowerCase()).find("[type='checkbox']").length,C=$("#"+c.toLowerCase()).find("[type='checkbox']:checked").length;k>0&&l&&(x-=k,C=Math.max(0,C-k));var w=Math.min(12,x);1==Math.floor((x-1)/12%2)&&(s=!s),x/12>1&&(n+=i*Math.floor(x/12)/2),s&&(p+=g,f+=g),r.font="14px "+u,r.textAlign="right",A("en"==lang?h[lang]:h.jp,p,n+16-9),r.save(),r.fillStyle="white",$($("#"+c.toLowerCase()).find("[type='checkbox']").get().reverse()).each(function(e){var t=$(this).parent().parent(),a=x-m-1;if(!l||!t.hasClass("blueprint")||t.hasClass("kai")){var s=f+a%12*v;Math.floor(a/12%2)>0&&(s=f+(12-(a+1)%12)*v-g);var o=Math.floor(a/12)*-i/2+n-15,r=document.getElementById("icon"+this.id),d=t.hasClass("blueprint")?t.hasClass("prototype")?"pink":"lightblue":"white";E(r,s,o,this.checked,d),m++}}),r.textAlign="left",r.font="14px "+b,A(C+"/"+m,f+w*v+8,n+16-9),r.restore(),n+=i/2,s=!s}var I=($("#cv").find("[type='checkbox']").length-(l?$("#cv").find(".blueprint").not(".kai").length:0)+2.5)*v,S=0,B=$("#ss").find("[type='checkbox']:checked").length;k=0;n-=i,A("en"==lang?"SS":"潜",190+I,n+i/2+16-9),r.save(),r.fillStyle="white",$("#ss").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(l&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&k++;else{var t=I+205+S*v,a=n-15+i/2,s=document.getElementById("icon"+this.id),o=$(this).parent().parent().find("label").hasClass("blueprint")?"lightblue":"white";E(s,t,a,this.checked,o),S++}}),r.textAlign="left",r.font="14px "+b,A(B-k+"/"+S,I+205+S*v+8,n+16-9+i/2),r.restore();var D=($("#cvl").find("[type='checkbox']").length-(l?$("#cvl").find(".blueprint").not(".kai").length:0)+3.5)*v,O=163+g,L=O+g;A("en"==lang?"AX":"その他",O+D,n+16-9);var F=0,R=$("#ax").find("[type='checkbox']:checked").length;k=0;r.save(),r.fillStyle="white",$("#ax").find("[type='checkbox']").each(function(){var e=$(this).parent().parent();if(l&&e.hasClass("blueprint")&&!e.hasClass("kai"))this.checked&&e.hasClass("blueprint")&&k++;else{var t=D+L+F*v,a=n-15,i=document.getElementById("icon"+this.id),s=$(this).parent().parent().find("label").hasClass("blueprint")?"lightblue":"white";E(i,t,a,this.checked,s),F++}}),r.textAlign="left",r.font="14px "+b,A(R-k+"/"+F,D+L+F*v+8,n+16-9),r.restore(),r.font="12px "+u;var j,T,N,M,W,Y,H=$(".shipOptions"),P=H.find(".blueprint").length-H.find(".kai").length,U=H.find(".blueprint :checked").length-H.find(".kai :checked").length,X=l?H.find("[type='checkbox']:checked").length-U:H.find("[type='checkbox']:checked").length,J=l?H.find("[type='checkbox']").length-P:H.find("[type='checkbox']").length;N=20,M=(j=X)+"/"+(T=J),W=j/T,Y=r.createLinearGradient(540,0,840,0),r.save(),r.strokeRect(540,o.height-N,300,8),Y.addColorStop(0,"#A00000"),Y.addColorStop(.33,"#FF9900"),Y.addColorStop(.66,"#DDDD33"),Y.addColorStop(1,"#00A000"),r.fillStyle=Y,r.fillRect(540,o.height-N,(300*W).toFixed(),8),r.restore(),r.font="20px "+b,A(M+" ("+(100*W).toFixed()+"%)",840,o.height-20,3),r.font="12px "+u,r.textAlign="center",A("Lv. "+(t.value?t.value:"?"),85,167),A("------"!==a?"en"==lang?a.substring(a.indexOf(" ")+1):a:"en"==lang?"Unknown Server":"不明サーバ",85,182),r.textAlign="left",r.restore(),$("#loadingDiv").html(""),$("#loadingProgress").hide(),$("#buttons button").prop("disabled",!1)},F=function(){for(var e in colle)$("#kore"+e).addClass("selected");$(".flagship").removeClass("flagship"),$(".damaged").removeClass("damaged");for(var e in fleets[0]){var t=fleets[0][e],a=t.substring(4);if(null!==t&&""!==t){0==e&&($("#"+t).addClass("flagship"),n=shipDB[a]?shipDB[a].rarity:0);var l=parseInt(e)+1;$("#slot"+l).html('<img style="height:50px; width:50px;" src="icons/'+shipDB[a].type+"/"+a+'.png"/>')}}for(var e in fleetLevels[0]){var i=parseInt(fleetLevels[0][e]);if(i&&i>0){l=parseInt(e)+1;$("#level"+l).val(i)}}x("initial")},R=function(){var s=l.mstId2FleetIdTable;if(shipTypes=l.shipTypes,apiMode){if(importName&&$("input[name='name']").val(importName),importLvl&&$("input[name='level']").val(importLvl),importServer&&$("select[name='server']").val(importServer),importShips){importShips=JSON.parse(importShips);var d={},c={};for(var h in importShips){if(importShips[h]in s)if(d[b=s[importShips[h]]]=!0,b in l.implicationTable)for(var g in l.implicationTable[b])d[l.implicationTable[b][g]]=!0}if(importK2){for(var h in d){if((b=$("#"+h)).length>0){var p=shipDB[h].type;c[p]||(c[p]={}),c[p][h]=!0,$("#"+h).prop("checked",!0)}}k2=c}importColle&&(colle=d)}if(importFleets){importFleets=JSON.parse(importFleets);var v=[new Array(6),new Array(6),new Array(6),new Array(6)],f=[[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1]];for(var m in importFleets)for(var h in importFleets[m])importFleets[m][h]&&null!=importFleets[m][h]&&s[importFleets[m][h].id]&&(v[m][h]="icon"+s[importFleets[m][h].id],f[m][h]=importFleets[m][h].lvl);fleets=v,fleetLevels=f}}r.strokeRect(0,0,o.width,o.height),r.imageSmoothingEnabled=!0,r.mozImageSmoothingEnabled=!0,r.webkitImageSmoothingEnabled=!0;h=0;for(var u in shipDB){var b;if((b=shipDB[u]).name){var y=$('<img class="tooltip" title="'+b.full+'" src="icons/'+b.type+"/"+u+'.png" id="icon'+u+'"></img>'),C=$('<span id="hit'+u+'">破</span>');y.on("load",function(){h++,$("#loadingProgress").html(h+"/"+Object.keys(shipDB).length),h==Object.keys(shipDB).length&&F()}),0==$(".shipList [data-name='"+b.name+"']").length&&$(".div"+b.type).append("<div><label>"+b.name.replace(new RegExp("_","g")," ")+'</label><div data-name="'+b.name+'" class="'+b.type+'"></div></div>'),b.unique&&$("#colleDiv [data-name='"+b.name+"']").append('<img title="'+b.full+'"alt="full/FinalBoss.png" src="icons/'+b.type+"/"+u+'.png" id="kore'+u+'"></img>').append(C),$("#avatars [data-name='"+b.name+"']").append(y).append(C)}}$("#colleDiv .shipClasses").each(function(e){var t=$("<div class='colleAll'><input id='selectAll-"+e+"' type='checkbox'/><label for='selectAll-"+e+"'>"+("jp"==lang?"全て選択":"cn"==lang||"tw"==lang?"全選":"Select All")+"</label></div>");$(this).append(t),t.find("input").change(function(){var e=$(this).parent().parent().find("img");for(var t in e.toArray()){var a=$(e[t]);colle[a.attr("id").substring(4)]=this.checked,a.toggleClass("selected",this.checked)}x("colleChangeAll")})}),$(".tooltip").tooltipster(),$(".shipClasses").find("label").next("div").each(function(){0==$(this).find("img").length&&$(this).parent().remove()}),$("#fleetSelect div").click(function(){$("#fleetSelect .chosen").removeClass("chosen"),$(this).toggleClass("chosen");var e=this.id.substring(5);t=parseInt(e)-1,$("#fleets div").html(""),$("#fleetLevels input").val(1);for(var a in fleets[t]){var l=fleets[t][a],i=parseInt(a)+1;null!==l&&""!==l&&$("#slot"+i).html('<img style="height:50px; width:50px;" src="'+$("#"+l).attr("src")+'"/>'),$("#level"+i).val(fleetLevels[t][a])}}),$("#fleets div").click(function(){$("#fleets .chosen").removeClass("chosen"),$(this).toggleClass("chosen");var e=this.id.substring(4);a=parseInt(e)-1}),$("#fleetLevels input").change(function(){var e=this.id.substring(5);a=parseInt(e)-1,fleetLevels[t][a]=this.value,x("fleetLevelChange")}),$("#avatars img").on("click",function(){$(this).hasClass("abyss")||(fleets[t][a]=$(this).attr("id"),$("#fleets .chosen").html('<img style="height:50px; width:50px;" src="'+$(this).attr("src")+'"/>')),0==t&&0==a&&($(".flagship").removeClass("flagship"),$(".damaged").removeClass("damaged"),$(this).toggleClass("flagship"),n=shipDB[this.id.substring(4)]?shipDB[this.id.substring(4)].rarity:0),x("fleetShipChange")}),$("#colleDiv img").on("click",function(){colle[$(this).attr("id").substring(4)]&&$(this).hasClass("selected")?delete colle[$(this).attr("id").substring(4)]:$(this).hasClass("selected")||(colle[$(this).attr("id").substring(4)]=!0),$(this).toggleClass("selected"),x("colleChange")}),$("#avatars span").on("click",k),$(".shipList > label").click(function(){$(this).next("div").slideToggle()}),$(".shipClasses label").click(function(){$(this).next("div").toggle()}),$("#removeSlot").click(function(){0==t&&0==a&&($(".damaged").removeClass("damaged"),$(".flagship").removeClass("flagship"),n=0),fleets[t][a]=null,$("#fleets .chosen").html(""),x("fleetRemoveSlot")}),$(".shipOptions input[type='checkbox']").change(function(){x("kainiShipChange")}),$("#selectAll").on("change",function(){this.checked?$(".shipOptions [type='checkbox']").prop("checked",!0):$(".shipOptions [type='checkbox']").prop("checked",!1),x("kainiSelectAll")}),$("#displayBadge").on("click",function(){$("#buttonToggles button").removeClass("active"),$(this).addClass("active"),o.width=850,o.height=240,x("displayBadge")}),$("#displayRoom").on("click",function(){$("#buttonToggles button").removeClass("active"),$(this).addClass("active"),o.width=850,o.height=510,D(132)}),$("#displayPoster").on("click",function(){$("#buttonToggles button").removeClass("active"),$(this).addClass("active"),o.width=850,o.height=510,x("displayPoster")}),$("#generate").on("click",x),$("#Floor,#Wall,#Desk,#Object,#Chest,#Window").on("change",function(){var t=this.id;delete e[t];var a=$("#active"+t),l=$(this).find(":checked").val();a.off("load"),a.attr("src","furniture/"+this.id.toLowerCase()+"/"+l+".png"),a.prop("complete")?$.isEmptyObject(e)&&"Window"!=t&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?D(132):x("furnitureChangeCache")):(e[t]=l,$("#buttons button").prop("disabled",!0),$("#loadingDiv").html("Rendering..."),a.load(function(){delete e[t],$.isEmptyObject(e)&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?D(132):x("furnitureChangeLoaded"))}).error(function(){delete e[t],$.isEmptyObject(e)&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html("Couldn't find this furniture's image."))})),"Window"==t&&$("#Outside").change()}),$("#Outside").on("change",function(t){delete e.Outside;var a=$("#activeOutside"),l=$("#Outside").find(":checked"),i=$("#Window").find(":checked").attr("data-pType"),n="furniture/outside/"+(l.val()+i)+".png";a.off("load"),a.attr("src",n),a.prop("complete")&&$.isEmptyObject(e)?($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?D(132):x("furnitureOutsideCache")):a.load(function(){delete e.Outside,$.isEmptyObject(e)&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?D(132):x("furnitureOutsideLoaded"))})}),$("#ttkInfo input[type='text'],#ttkInfo input[type='number']").blur(function(){x("ttkInfo")}),$("#ttkInfo select").click(function(){x("ttkServer")}),$("#ttkInfo input[type='checkbox']").click(function(){x("ttkLevel")}),$("#loadAbyss").click(function(){$("#loadAbyss").remove(),$("#avatars .hidden").removeClass("hidden"),$.ajax({dataType:"json",timeout:1e4,url:"en"==lang?"db2.json?v=13":"db2j.json?v=13",success:function(e){i=e,$("#loadingDiv").html("Loading images: "),$("#loadingProgress").show().html("0/"+Object.keys(e).length);var t=0;for(var a in i){var l=e[a];if(l.name){var s=$('<img class="abyss tooltip2" title="'+l.full+'" src="icons/'+l.type+"/"+a+'.png" id="icon'+a+'"></img>'),o=$('<span class="abyss" id="hit'+a+'">破</span>');s.on("load",function(){t++,$("#loadingProgress").html(t+"/"+Object.keys(e).length),t==Object.keys(e).length&&($("#loadingDiv").html(""),$("#loadingProgress").hide())}),s.on("click",function(){$(".flagship").removeClass("flagship"),$(".damaged").removeClass("damaged"),$(this).toggleClass("flagship"),n=0,x("fleetShipChangeAbyss")}),0==$(".shipList [data-name='"+l.name+"']").length&&$(".div"+l.type).append("<div><label>"+l.name.replace(new RegExp("_","g")," ")+'</label><div data-name="'+l.name+'" class="'+l.type+'"></div></div>'),$("#avatars [data-name='"+l.name+"']").append(s),l.damageable&&$("#avatars [data-name='"+l.name+"']").append(o)}}$("#avatars span").unbind("click").on("click",k),$(".tooltip2").tooltipster()},error:function(){$("#loadingDiv").html("Can't find Abyssal DB, please contact Harvestasya or Nya-chan on Github")}})}),$("#save").on("click",function(){!function(){var e=$(".furnitureClass input:checked").toArray(),t={};for(var a in e)t[e[a].name]=e[a].id;$(".shipClass").each(function(){var e=this.id,t={};$(this).find("input").each(function(e){t[this.id]=$(this).prop("checked")}),k2[e]=t}),store("ttkName",$("input[name='name']").val()),store("ttkLvl",$("input[name='level']").val()),store("ttkServer",$("select[name='server']").val()),store("ttkFurn",Base64.encode(JSON.stringify(t))),store("ttkFurnCam",$("#roomY").val()),store("ttkTint",$("#tint-color").val()),store("ttkHexOpa",$("#hexOpa").val()),store("k2",Base64.encode(JSON.stringify(k2))),store("secretaryCam",JSON.stringify([$("#customX").val(),$("#customY").val(),$("#customZ").val()])),store("secretaryHit",$(".damaged").size()>0&&!$($(".damaged")[0]).hasClass("abyss")),store("fleet",Base64.encode(fleets.join("|"))),store("fleetLvl",Base64.encode(fleetLevels.join("|"))),store("colle",Base64.encode(JSON.stringify(colle))),store("bg",globalbg),store("bgUse",$("#useBG").prop("checked")),store("bgCam",JSON.stringify([$("#bgX").val(),$("#bgY").val(),$("#bgZ").val()])),store("bgStretch",$("#bgStretch").prop("checked")),store("avatar",globalavatar)}(),this.setAttribute("disabled","disabled")}),$("#load").on("click",function(){!function(){$(".flagship").removeClass("flagship"),$(".damaged").removeClass("damaged"),$("input[name='name']").val(restore("ttkName")),$("input[name='level']").val(restore("ttkLvl"));var e=restore("bgCam");e=e?JSON.parse(e):[0,0,100],$("#bgX").val(e[0]),$("#bgY").val(e[1]),$("#bgZ").val(e[2]),$("#useBG").prop("checked",!restore("bgUse")||"true"==restore("bgUse"));var t=restore("secretaryCam");t=t?JSON.parse(t):[0,0,0],$("#customX").val(t[0]),$("#customY").val(t[1]),$("#customZ").val(t[2]),$("#roomY").val(restore("ttkFurnCam")||0),$("#tint-color").val(restore("ttkTint")||"#ffffff"),$("#hexOpa").val(restore("ttkHexOpa")||.33),$("#hexOpa").val(restore("ttkHexOpa")||.33),$("#bgStretch").prop("checked",!restore("bgStretch")||"true"==restore("bgStretch")),"null"!=(globalbg=restore("bg"))&&$("#bg").attr("src",globalbg),"null"!=(globalavatar=restore("avatar"))?$("#avatar").attr("src",globalavatar):$("#avatar").removeAttr("src");var a=restore("ttkServer");"null"!=a&&$("select[name='server']").val(a);var l=restore("k2");l=l?JSON.parse(Base64.decode(l)):null;var i=restore("colle");i=i?JSON.parse(Base64.decode(i)):null;var s=restore("ttkFurn");s=s?JSON.parse(Base64.decode(s)):null;var o=restore("fleet");o=o?Base64.decode(o).split("|"):null;for(var r in o)o[r]=o[r].split(",");var d=restore("fleetLvl");d=d?Base64.decode(d).split("|"):null;for(var r in d)d[r]=d[r].split(",");if(l){k2=l,$(".shipClass input").prop("checked",!1);for(var r in k2)for(var c in k2[r])$("#"+c).prop("checked",k2[r][c])}if(i){colle=i,$("#colleDiv img").removeClass("selected");for(var r in colle)$("#kore"+r).addClass("selected")}if(o){fleets=o;for(var r in fleets[0]){var h=fleets[0][r];if(null!==h&&""!==h){0==r&&($("#"+h).addClass("flagship"),"true"==restore("secretaryHit")&&$("#"+h).next("span").addClass("damaged"),n=shipDB[h.substring(4)]?shipDB[h.substring(4)].rarity:0);var g=parseInt(r)+1;$("#slot"+g).html('<img style="height:50px; width:50px;" src="'+$("#"+h).attr("src")+'"/>')}}}if(d){fleetLevels=d;for(var r in fleetLevels[0]){var p=parseInt(fleetLevels[0][r]);p&&p>0&&(g=parseInt(r)+1,$("#level"+g).val(p))}}if(s){var v=0;$("#buttons button").prop("disabled",!0),$("#loadingDiv").html("Rendering...");var f=!1;for(var r in s){var m=s[r],u=$("#"+m);u.prop("checked",!0);var b=u.parent().parent().parent().attr("id"),y=$("#active"+b);if(y.off("load"),"Outside"==b){var k=$("#Outside").find(":checked"),C=$("#Window").find(":checked").attr("data-pType"),w="furniture/outside/"+(I=k.val()+C)+".png";y.attr("src",w)}else{var I=u.val();y.attr("src","furniture/"+b.toLowerCase()+"/"+I+".png")}y.prop("complete")?++v==Object.keys(s).length&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(""),$("#displayRoom").hasClass("on")?D(132):x("loadAllImgCached")):y.load(function(){++v==Object.keys(s).length&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html(f?"Couldn't find a furniture's image.":""),$("#displayRoom").hasClass("on")?D(132):x("loadAllImgLoaded"))}).error(function(e){f=!0,++v==Object.keys(s).length&&($("#buttons button").prop("disabled",!1),$("#loadingDiv").html("Couldn't find a furniture's image."))})}}else x("loadNoFurniture")}()}),$("#export").on("click",function(){var e=document.createElement("img");$(e).attr("src",o.toDataURL("image/png"));var t=document.createElement("div");$(t).attr("class","export-container"),$(t).append(e);var a=document.createElement("span");$(a).text('Right-click the image and choose "Save As..." to save it to your computer.'),$(t).append(a);var l=document.createElement("span");$(l).attr("class","close"),$(l).text("+"),$(t).append(l),$("body").prepend(t)}),$("body").on("click",".export-container",function(){$(".export-container").remove()}),$("#avatar").load(function(){$.isEmptyObject(e)&&x("avatarImgChange")}),$("#bg").load(function(){$.isEmptyObject(e)&&x("bgImgChange")}),$("#customInputs input[type='checkbox']").change(function(){x("customInputChange")}),$("#customInputs input[type='number']").change(function(){x("customInputChange")}),$("#avatarImg").change(function(){if(this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){$("#avatar").attr("src",e.target.result),globalavatar=e.target.result},e.readAsDataURL(this.files[0])}}),$("#shipImg").change(function(){if(this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){$("#customShip").attr("src",e.target.result),globalship=e.target.result,x("customShipChange")},e.readAsDataURL(this.files[0])}}),$("#bgImg").change(function(){if($("#useBG").prop("checked",!1),this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){$("#bg").attr("src",e.target.result),globalbg=e.target.result},e.readAsDataURL(this.files[0])}}),$("#shipClear").click(function(){globalship=null,$("#shipImg").val(""),$("#customShip").removeAttr("src"),x("clear")}),$("#avatarClear").click(function(){globalavatar=null,$("#avatarImg").val(""),$("#avatar").removeAttr("src"),x("clear")}),$("#bgClear").click(function(){globalbg=null,$("#bgImg").val(""),$("#bg").attr("src","bg.jpg"),x("clear")})}}),$(window).load(function(){$("#tabs").liteTabs({width:"100%"}),$("#tabs").show(),$(".furnitureClass.invert > div div").each(function(){$(this).prependTo(this.parentNode)})});